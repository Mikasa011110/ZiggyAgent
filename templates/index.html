<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>Ziggy Agent</title>
    <style>
        /* ä¿®æ”¹Ziggyå½¢è±¡ä¸ºå›ºå®šå®šä½ */
        .ziggy-avatar {
            position: fixed;
            left: 80px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            border: 3px solid #ddd;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 1000;
            /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
        }

        /* ä¸åŒæƒ…ç»ªçš„å½¢è±¡ */
        .avatar-default {
            background-image: url('/static/images/ziggy_default.png');
        }

        .avatar-anger {
            background-image: url('/static/images/ziggy_anger.png');
        }

        .avatar-happiness {
            background-image: url('/static/images/ziggy_happy.png');
        }

        .avatar-surprise {
            background-image: url('/static/images/ziggy_surprise.png');
        }

        .avatar-fear {
            background-image: url('/static/images/ziggy_fear.png');
        }

        .avatar-sadness {
            background-image: url('/static/images/ziggy_sadness.png');
        }

        /* æ€è€ƒçŠ¶æ€è¦†ç›–å±‚ */
        .thinking-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            display: none; /* é»˜è®¤éšè— */
        }

        .thinking-overlay img {
            width: 80%;
            height: 80%;
            object-fit: contain;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(0.95); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 1; transform: scale(0.95); }
        }

        /* è°ƒæ•´èŠå¤©å®¹å™¨å·¦è¾¹è· */
        .chat-container {
            width: 60%;
            margin: 0 auto;
            padding-left: 180px;
            /* ä¸ºZiggyå›¾ç‰‡ç•™å‡ºç©ºé—´ */
            box-sizing: border-box;
        }

        /* æ·»åŠ è‡ªåŠ¨åˆ†ææŒ‡ç¤ºå™¨ */
        .auto-analysis-indicator {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }

        .auto-analysis-active {
            color: #4CAF50;
            font-weight: bold;
        }

        .analysis-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
            margin-right: 5px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        body {
            font-family: Arial, sans-serif;
        }

        .chat-container {
            width: 60%;
            margin: 0 auto;
        }

        .message {
            padding: 10px;
            margin: 10px 0;
        }

        .user-message {
            background-color: #f0f0f0;
        }

        .agent-message {
            background-color: #d1f1d1;
        }

        .input-container {
            margin-top: 20px;
        }

        /* Token æ˜¾ç¤ºæ ·å¼ */
        .token-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .token-progress {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .token-progress-bar {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .token-count {
            text-align: center;
            font-weight: bold;
            margin-top: 5px;
        }

        /* è¡¨æƒ…è¯†åˆ«åŒºåŸŸæ ·å¼ */
        .emotion-section {
            margin: 25px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
            /* é»˜è®¤éšè— */
        }

        .video-container {
            position: relative;
            width: 320px;
            height: 240px;
            margin: 10px auto;
            border: 3px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            display: none;
        }

        .emotion-result {
            margin-top: 15px;
            text-align: center;
            font-size: 18px;
        }

        .emotion-text {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
        }

        /* æƒ…ç»ªé¢œè‰²ç¼–ç  */
        .emotion-surprise {
            color: #FFA500;
            background: #FFF3E0;
        }

        .emotion-fear {
            color: #800080;
            background: #F3E5F5;
        }

        .emotion-disgust {
            color: #008000;
            background: #E8F5E9;
        }

        .emotion-happiness {
            color: #FFD700;
            background: #FFFDE7;
        }

        .emotion-sadness {
            color: #1E90FF;
            background: #E3F2FD;
        }

        .emotion-anger {
            color: #FF4500;
            background: #FFEBEE;
        }

        .emotion-neutral {
            color: #A9A9A9;
            background: #FAFAFA;
        }

        .emotion-uncertain {
            color: #FF6B6B;
            background: #FFEBEE;
        }

        /* æƒ…ç»ªæ¦‚ç‡åˆ†å¸ƒæ ·å¼ */
        .emotion-probs {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 14px;
        }

        .emotion-prob-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
        }

        .prob-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-left: 10px;
            flex: 1;
            position: relative;
        }

        .prob-fill {
            height: 100%;
            background: #4CAF50;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .warning-message {
            color: #FF6B6B;
            font-weight: bold;
            margin-top: 10px;
        }

        /* æœ€è¿‘æƒ…ç»ªå†å²æ ·å¼ */
        .emotion-history {
            margin-top: 15px;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 1px solid #d1e7ff;
        }

        .emotion-history h4 {
            margin-top: 0;
            color: #1e88e5;
        }

        .emotion-history-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            margin: 3px 0;
            border-bottom: 1px dashed #d1e7ff;
        }

        .emotion-history-label {
            font-weight: bold;
            color: #555;
        }

        /* è¡¨æƒ…åˆ†ææŒ‰é’®æ ·å¼ */
        .toggle-analysis-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px auto;
            display: block;
        }

        .toggle-analysis-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>

<body>
    <!-- Ziggyå½¢è±¡å±•ç¤º -->
    <div class="ziggy-avatar" id="ziggy-avatar">
        <!-- æ€è€ƒçŠ¶æ€è¦†ç›–å±‚ -->
        <div class="thinking-overlay" id="thinking-overlay">
            <img src="/static/images/ziggy_thinking.png" alt="æ€è€ƒä¸­...">
        </div>
    </div>

    <div class="chat-container">
        <!-- æ·»åŠ æç¤ºä¿¡æ¯ -->
        <div style="margin: 20px 0; padding: 15px; background-color: #fff8e1; border-left: 5px solid #ffc107; color: #5d4037;">
            <p style="margin: 5px 0; font-weight: bold;">âš ï¸ Ziggyéœ€è¦å‡ ç§’çš„æ€è€ƒæ—¶é—´ï¼</p>
            <p style="margin: 5px 0; font-weight: bold;">âš ï¸ è¯·å‹¿è¿ç»­ç‚¹å‡»æäº¤ï¼ˆsubmitï¼‰æˆ–å›è½¦</p>
        </div>

        <!-- Token ä½¿ç”¨æƒ…å†µ -->
        <div class="token-info">
            <h3>Token ä½¿ç”¨æƒ…å†µ</h3>
            <div class="token-progress">
                <div class="token-progress-bar" id="token-bar"></div>
            </div>
            <div class="token-count">
                <span id="current-tokens">0</span>/<span id="max-tokens">4096</span> tokens
            </div>
        </div>

        <!-- è¡¨æƒ…åˆ†ææŒ‰é’® -->
        <button class="toggle-analysis-btn" id="toggle-analysis-btn">æ˜¾ç¤ºè¡¨æƒ…åˆ†æ</button>

        <!-- è¡¨æƒ…è¯†åˆ«åŒºåŸŸ -->
        <div class="emotion-section" id="emotion-section">
            <h3>è¡¨æƒ…è¯†åˆ« (è‡ªåŠ¨æ¨¡å¼)</h3>
            <div class="auto-analysis-indicator" id="auto-analysis-indicator">
                <span class="analysis-spinner" id="analysis-spinner"></span>
                <span id="analysis-status">åˆ†æä¸­...</span>
            </div>
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
            </div>
            <div class="emotion-result">
                å½“å‰æƒ…ç»ª: <span id="emotion-text" class="emotion-text emotion-neutral">æœªæ£€æµ‹</span>
                <span id="emotion-emoji"></span>
                <div>ç½®ä¿¡åº¦: <span id="confidence-text">0</span>%</div>
                <div id="warning-message" class="warning-message" style="display: none;"></div>
            </div>
            <div id="emotion-probs" class="emotion-probs" style="display: none;">
                <h4>æƒ…ç»ªæ¦‚ç‡åˆ†å¸ƒ:</h4>
                <div id="prob-list"></div>
            </div>

            <!-- æœ€è¿‘æƒ…ç»ªå†å² -->
            <div class="emotion-history">
                <h4>æœ€è¿‘3æ¬¡æƒ…ç»ªæ£€æµ‹:</h4>
                <div id="emotion-history-list"></div>
            </div>
        </div>

        <!-- èŠå¤©è®°å½• -->
        <div class="messages">
            {% for msg in history %}
            {% if msg.role == 'user' %}
            <div class="message user-message"><strong>Youï¼š</strong> {{ msg.content }}</div>
            {% elif msg.role == 'assistant' %}
            <div class="message agent-message"><strong>Ziggyï¼š</strong> {{ msg.content }}</div>
            {% endif %}
            {% endfor %}
        </div>

        <!-- ç”¨æˆ·è¾“å…¥æ¡† -->
        <form method="POST" class="input-container" id="chat-form">
            <input type="text" id="user-input" name="user_input" placeholder="Please enter your question..." required
                style="width: 80%; padding: 10px;">
            <input type="hidden" name="recent_emotions" id="recent-emotions-input">
            <button type="submit" style="padding: 10px;">Submit</button>
        </form>

        <!-- æ¸…é™¤æŒ‰é’® -->
        <form method="POST" action="/clear_history">
            <button type="submit" style="margin-top:10px;">æ¸…é™¤å¯¹è¯</button>
        </form>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–Ziggyå½¢è±¡
        document.addEventListener('DOMContentLoaded', function () {
            // è·å–å½“å‰æƒ…ç»ª
            const currentEmotion = "{{ current_emotion }}";
            const avatarElem = document.getElementById('ziggy-avatar');
            
            // è®¾ç½®å¯¹åº”çš„å½¢è±¡ç±»
            if (currentEmotion) {
                avatarElem.classList.add(`avatar-${currentEmotion}`);
            } else {
                avatarElem.classList.add('avatar-default');
            }
            
            // ç¡®ä¿è¾“å…¥åŒºåŸŸå¯è§
            document.querySelector('.input-container').style.display = 'block';
        });

        // è‡ªåŠ¨åˆ†æé—´éš”ï¼ˆæ¯«ç§’ï¼‰
        const AUTO_ANALYSIS_INTERVAL = 3000;
        let analysisInterval = null;
        let emotionHistory = []; // å­˜å‚¨æœ€è¿‘3æ¬¡æƒ…ç»ªæ£€æµ‹ç»“æœ
        let cameraStarted = false; // è·Ÿè¸ªæ‘„åƒå¤´æ˜¯å¦å·²å¯åŠ¨

        // Tokenè®¡æ•°åŠŸèƒ½
        function fetchTokenUsage() {
            fetch('/get_token_usage')
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('current-tokens').textContent = data.used_tokens;
                    document.getElementById('max-tokens').textContent = data.limit;
                    const percentage = Math.min((data.used_tokens / data.limit) * 100, 100);
                    const progressBar = document.getElementById('token-bar');
                    progressBar.style.width = `${percentage}%`;
                    progressBar.style.background = percentage > 80 ? '#dc3545' : percentage > 50 ? '#ffc107' : '#4CAF50';
                })
                .catch(error => {
                    console.error('è·å–Tokenæ•°æ®å¤±è´¥:', error);
                });
        }

        // è¡¨æƒ…è¯†åˆ«åŠŸèƒ½
        const emotionEmojis = {
            'surprise': 'ğŸ˜²',
            'fear': 'ğŸ˜¨',
            'disgust': 'ğŸ¤¢',
            'happiness': 'ğŸ˜Š',
            'sadness': 'ğŸ˜¢',
            'anger': 'ğŸ˜ ',
            'neutral': 'ğŸ˜',
            'uncertain': 'â“'
        };

        // å¯åŠ¨æ‘„åƒå¤´
        function startCamera() {
            if (cameraStarted) return;

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    const video = document.getElementById('video');
                    video.srcObject = stream;
                    cameraStarted = true;
                    // æ‘„åƒå¤´å¯åŠ¨åå¼€å§‹è‡ªåŠ¨åˆ†æ
                    startAutoAnalysis();
                })
                .catch(err => {
                    console.error("æ‘„åƒå¤´é”™è¯¯:", err);
                    alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæƒé™");
                    document.getElementById('emotion-text').textContent = "æ‘„åƒå¤´é”™è¯¯";
                });
        }

        // å¯åŠ¨è‡ªåŠ¨è¡¨æƒ…åˆ†æ
        function startAutoAnalysis() {
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            document.getElementById('analysis-status').textContent = "è‡ªåŠ¨åˆ†æä¸­...";
            document.getElementById('analysis-spinner').style.display = "inline-block";
            document.getElementById('auto-analysis-indicator').classList.add('auto-analysis-active');

            // æ¯3ç§’åˆ†æä¸€æ¬¡
            if (analysisInterval) clearInterval(analysisInterval);
            analysisInterval = setInterval(analyzeCurrentFrame, AUTO_ANALYSIS_INTERVAL);
        }

        // åˆ†æå½“å‰å¸§ï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰
        async function analyzeCurrentFrame() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');

            // ç¡®ä¿è§†é¢‘å·²å‡†å¤‡å¥½
            if (video.readyState < 2) {
                console.log("è§†é¢‘å°šæœªå‡†å¤‡å¥½");
                return;
            }

            // è®¾ç½®canvaså°ºå¯¸ä¸è§†é¢‘ç›¸åŒ
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // ç»˜åˆ¶å½“å‰å¸§åˆ°canvas
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆä»…åœ¨åŒºåŸŸæ˜¾ç¤ºæ—¶æ›´æ–°UIï¼‰
            if (document.getElementById('emotion-section').style.display === 'block') {
                document.getElementById('emotion-text').textContent = "æ£€æµ‹ä¸­...";
                document.getElementById('emotion-emoji').textContent = "";
                document.getElementById('confidence-text').textContent = "0";
            }

            try {
                // å°†canvaså›¾åƒè½¬æ¢ä¸ºbase64
                const imageData = canvas.toDataURL('image/jpeg', 0.9);

                // å‘é€åˆ°åç«¯åˆ†æ
                const response = await fetch('/analyze_emotion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }

                // ä»…åœ¨åŒºåŸŸæ˜¾ç¤ºæ—¶æ›´æ–°UIç»“æœ
                if (document.getElementById('emotion-section').style.display === 'block') {
                    updateEmotionResult(result.emotion, result.confidence, result.all_emotions, result.message);
                }

                // æ·»åŠ åˆ°æƒ…ç»ªå†å²ï¼ˆå§‹ç»ˆæ›´æ–°ï¼‰
                addToEmotionHistory(result.emotion, result.confidence);

            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                // ä»…åœ¨åŒºåŸŸæ˜¾ç¤ºæ—¶æ›´æ–°UIé”™è¯¯
                if (document.getElementById('emotion-section').style.display === 'block') {
                    document.getElementById('emotion-text').textContent = "åˆ†æå¤±è´¥";
                    document.getElementById('confidence-text').textContent = "";
                }
            }
        }

        // æ›´æ–°æƒ…ç»ªç»“æœæ˜¾ç¤º
        function updateEmotionResult(emotion, confidence, allEmotions, message) {
            const emotionElem = document.getElementById('emotion-text');
            emotionElem.textContent = emotion;
            emotionElem.className = `emotion-text emotion-${emotion}`;

            document.getElementById('emotion-emoji').textContent =
                emotionEmojis[emotion] || '';
            document.getElementById('confidence-text').textContent = confidence;

            // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
            const warningElem = document.getElementById('warning-message');
            if (message) {
                warningElem.textContent = message;
                warningElem.style.display = 'block';
            } else {
                warningElem.style.display = 'none';
            }

            // æ˜¾ç¤ºæ‰€æœ‰æƒ…ç»ªæ¦‚ç‡åˆ†å¸ƒ
            if (allEmotions) {
                const probList = document.getElementById('prob-list');
                probList.innerHTML = '';

                Object.entries(allEmotions).forEach(([emotionName, prob]) => {
                    const item = document.createElement('div');
                    item.className = 'emotion-prob-item';
                    item.innerHTML = `
                        <span>${emotionName}: ${prob}%</span>
                        <div class="prob-bar">
                            <div class="prob-fill" style="width: ${prob}%"></div>
                        </div>
                    `;
                    probList.appendChild(item);
                });

                document.getElementById('emotion-probs').style.display = 'block';
            } else {
                document.getElementById('emotion-probs').style.display = 'none';
            }
        }

        // æ·»åŠ åˆ°æƒ…ç»ªå†å²
        function addToEmotionHistory(emotion, confidence) {
            // æ·»åŠ æ–°ç»“æœåˆ°æ•°ç»„
            emotionHistory.push({
                emotion: emotion,
                confidence: confidence,
                timestamp: new Date().toLocaleTimeString()
            });

            // åªä¿ç•™æœ€è¿‘3æ¬¡ç»“æœ
            if (emotionHistory.length > 3) {
                emotionHistory.shift();
            }

            // æ›´æ–°UIæ˜¾ç¤ºï¼ˆä»…åœ¨åŒºåŸŸæ˜¾ç¤ºæ—¶æ›´æ–°ï¼‰
            if (document.getElementById('emotion-section').style.display === 'block') {
                updateEmotionHistoryUI();
            }
        }

        // æ›´æ–°æƒ…ç»ªå†å²UI
        function updateEmotionHistoryUI() {
            const historyList = document.getElementById('emotion-history-list');
            historyList.innerHTML = '';

            if (emotionHistory.length === 0) {
                historyList.innerHTML = '<div class="emotion-history-item">æ— å†å²è®°å½•</div>';
                return;
            }

            // å€’åºæ˜¾ç¤ºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢
            const reversedHistory = [...emotionHistory].reverse();

            reversedHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'emotion-history-item';
                historyItem.innerHTML = `
                    <div>
                        <span class="emotion-history-label">${item.emotion}</span>
                        <span class="emotion-text emotion-${item.emotion}">${item.confidence}%</span>
                    </div>
                    <div>${item.timestamp}</div>
                `;
                historyList.appendChild(historyItem);
            });
        }

        // åˆ‡æ¢è¡¨æƒ…åˆ†æåŒºåŸŸçš„æ˜¾ç¤º
        function toggleAnalysisSection() {
            const section = document.getElementById('emotion-section');
            const btn = document.getElementById('toggle-analysis-btn');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                btn.textContent = 'éšè—è¡¨æƒ…åˆ†æ';
                // æ˜¾ç¤ºæ—¶æ›´æ–°UI
                updateEmotionHistoryUI();
            } else {
                section.style.display = 'none';
                btn.textContent = 'æ˜¾ç¤ºè¡¨æƒ…åˆ†æ';
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            fetchTokenUsage();
            startCamera(); // å§‹ç»ˆå¯åŠ¨æ‘„åƒå¤´å’Œåˆ†æ

            // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('toggle-analysis-btn').addEventListener('click', toggleAnalysisSection);

            // è¡¨å•æäº¤äº‹ä»¶å¤„ç†
            document.getElementById('chat-form').addEventListener('submit', function (e) {
                // æ˜¾ç¤ºæ€è€ƒè¦†ç›–å±‚
                document.getElementById('thinking-overlay').style.display = 'flex';
                
                // éšè—è¾“å…¥æ¡†å’Œæäº¤æŒ‰é’®
                const inputContainer = document.querySelector('.input-container');
                inputContainer.style.display = 'none';
                
                // æ›´æ–°tokenè®¡æ•°
                setTimeout(fetchTokenUsage, 300);
                
                // å°†æœ€è¿‘æƒ…ç»ªå†å²è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                const emotionsJson = JSON.stringify(emotionHistory);
                document.getElementById('recent-emotions-input').value = emotionsJson;
            });

            // æ·»åŠ æ¸…é™¤å†å²æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
            document.querySelector('form[action="/clear_history"] button').addEventListener('click', function () {
                // é‡ç½®å‰ç«¯Tokenæ˜¾ç¤º
                setTimeout(() => {
                    fetchTokenUsage();
                    // åŒæ—¶æ¸…ç©ºå‰ç«¯çš„æƒ…ç»ªå†å²
                    emotionHistory = [];
                    updateEmotionHistoryUI();
                }, 300);
            });
        });
    </script>
</body>

</html>